trigger:
- develop

pool:
  vmImage: ubuntu-latest

variables:
  YARN_CACHE_FOLDER: $(Pipeline.Workspace)/s/.yarn

steps:
## Generic
- task: NodeAndNpmTool@1
  displayName: "Install node 18.20.2"
  inputs:
    versionSpec: '18.20.2'

- script: npm install -g yarn@1.22.19
  displayName: "Install yarn 1.22.19"

- task: Cache@2
  inputs:
    key: '"yarn" | "$(Agent.OS)" | src/yarn.lock'
    restoreKeys: |
       "yarn" | "$(Agent.OS)"
       "yarn"
    path: $(YARN_CACHE_FOLDER)
  displayName: Cache Yarn packages

## Build Mobile
- script: |
    cd src/apps/mobile
    yarn install
  displayName: "Install build mobile deps"

- script: |
    cd src/apps/mobile
    yarn build
  displayName: "Build mobile"

## Build Web
- script: |
    cd src/apps/web
    yarn install
  displayName: "Install build web deps"

- script: |
    cd src/apps/web
    yarn build
  displayName: "Build web"

# List Builds
- script: |
    ls -R $(System.DefaultWorkingDirectory)/src/apps/mobile/out
  displayName: "List mobile build directory"

- script: |
    ls -R $(System.DefaultWorkingDirectory)/src/apps/web/out
  displayName: "List web build directory"

# Archive Builds
- publish: $(System.DefaultWorkingDirectory)/src/apps/mobile/out
  artifact: mobile-drop
  displayName: "Publish mobile artifact"

- publish: $(System.DefaultWorkingDirectory)/src/apps/web/out
  artifact: web-drop
  displayName: "Publish web artifact"